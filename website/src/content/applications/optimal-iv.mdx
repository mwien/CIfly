---
title: Optimal conditional instruments
summary: Finding an asymptotically optimal conditional instrumental set.
code: [optimalIV.R]
ruletables: [descendants_admg, optimal_iv_admg]
graph: ADMG
language: R
references: [henckelIV]
---

import ExampleCode from "../../components/ExampleCode.astro"
import Ruletable from "../../components/Ruletable.astro"
import Reference from "../../components/Reference.astro"

In this article, we show how to implement an algorithm for constructing a graphically optimal conditional instrumental set. Instrumental variables are a popular tool for identifying and estimating causal effects and conditional instrumental sets generalize this notion further. As there may be many different conditional instruments in a causal graph, it is an important question which intruments to prefer over others. <Reference id="henckelIV" format="author(year)"/> develop conditonal instruments with statistical efficiency guarantees they call *graphical optimality*. The main result is stated in the following theorem. 

**Theorem 1** [<Reference id="henckelIV" format="author(year)"/>]    
Let $x$ and $y$ be distinct nodes in an ADMG $G$ such that $\text{de}(x)_G = \{x, y\}$. It holds for $W^{\text{opt}} = \text{dis}^+_{G, \{x\}}(y) \setminus \{x, y\}$ and $Z^{\text{opt}} = \text{dis}^+_{G, \{y\}}(x) \setminus (W^{\text{opt}} \cup \{x, y\})$ that
1. if $Z^\text{opt} \neq \emptyset$, then $(Z^\text{opt}, W^\text{opt})$ is a valid conditional instrumental set relative to $(x, y)$ in $G$ and
2. if $Z^\text{opt} \cap (\text{pa}_G(x) \cup \text{sib}_G(x)) \neq \emptyset$, then $(Z^\text{opt}, W^\text{opt})$ is graphically optimal relative to $(x, y)$ in $G$. 

The criterion is stated of ADMGs, which are graphs with both directed and bidirected edges that do not contain a directed cycle. , $\text{pa}_G(x)$ are the parents of $x$ in $G$, i.e., nodes $p$ with $p \rightarrow x$, and $\text{sib}_G(x)$ are the siblings of $x$ in $G$, i.e., the nodes with $p \leftrightarrow x$. Further, $\text{dis}_{G, W}(x)$ contains all nodes connected to $x$ via a path of bidirected edges, with all nodes on the path not being in $W$, and $\text{dis}_{G, W}^+(x) = (\text{dis}_{G, W}(x) \cup \text{pa}_G(\text{dis}_{G, W}(x))) \setminus W$. 

The criterion assumes that $y$ is the only descendant of $x$, which may appear like a strong restriction. However, one may consider the *latent projection* over all other descendants of $x$ to satisfy this condition. The only consequence of this, is that no descendants of $x$ in the original graph can be part of the instrumental set. However, this is a mild assumption because if such variables could be used as part of the instrument, then the causal effect would also be identifiable using adjustment. Therefore, in the following, we will always assume that this is not the case and the causal effect *cannot* be identified by adjustment. Checking this is also possible using CIfly, however, it goes beyond the scope of this article. 

While using the latent projection over all descendants of $x$ (apart from $y$) is correct under this assumption, algorithmically, computing the latent projection is more expensive than CIfly reachability algorithms. Hence, we would like to avoid this operation here. To this aim, we use the following graphical formulation for $W^\text{opt}$ and $Z^\text{opt}$ in the CIfly paper. 

**Theorem 2**    
Consider distinct nodes $x$ and $y$ in an ADMG $G$ and $D = \text{de}_G(x)$ such that $y \in D$ and let $A = V \setminus D$. Then, $W^{\text{opt}}$ and $Z^{\text{opt}}$ for the graph obtained by latent projection over $D \setminus \{x, y\}$ are equivalent to the following constructions in $G$:
1. $W^{\text{opt}} = \{ v \in V \; \mid \; v \text{ is on a path } p \rightarrow c_1 \leftrightarrow \cdots \leftrightarrow \cdots c_k \leftrightarrow d_1 \rightarrow \cdots \rightarrow \cdots d_l \rightarrow y \} \cap A$,  where $p, c_1, \dots, c_k \in A$ and $d_1, \dots, d_l \in (D \setminus \{ x \})$ possibly with $k=0$ or $l=0$ and 
2. $Z^{\text{opt}} = \{ v \in V \; \mid \; v \text{ is on a path } p \rightarrow c_1 \leftrightarrow \cdots \leftrightarrow c_k \leftrightarrow x\} \setminus W^{\text{opt}}$, where  $p, c_1, \dots, c_k \in A$ possibly with $k=0$.

Using this theorem, we proceed as follows:
1. Check that $y \in \text{de}_G(x)$. 
2. Compute $W^{\text{opt}}$ and $Z^{\text{opt}}$ as defined in Theorem 2. 
3. Check Condition 1. and 2. of Theorem 1.

This will guarantee that the resulting sets $W^{\text{opt}}$ and $Z^{\text{opt}}$ constitute graphical optimal instrumental sets, assuming that there is no adjustment set relative to $x$ and $y$ in $G$. Now, let us consider the three steps one-by-one.

#### Descendant check
Of course, the task of checking whether $y$ is a descendant of $x$ in $G$ is obvious and available in many off-the-shelf graph packages. Still, we show how it can be easily done in CIfly as well. For this, we use the following rule table. 

<Ruletable id="descendants_admg"/>

Effectively, this table describes to start at the nodes in $X$ as if the last edge was $\rightarrow$ and from there only follow directed edges. All reached nodes are returned as the descendants of $X$. We can use this in R to check whether $y \in \text{de}_G(x)$. 

TODO: adapt code at bottom like this

```py
descendants <- reach(g, list("X" = x), descendantsTable)
isDescendant <- y %in% descendants
```

#### Compute $W^{\text{opt}}$ and $Z^{\text{opt}}$
We will compute both $W^{\text{opt}}$ and $Z^{\text{opt}}$ using the same underlying ruletable. Let us begin with $W^{\text{opt}}$. Here, we want to start at $y$ and track paths that, first, follow edges $\leftarrow$ (assuming the respective nodes are in $D \setminus \{x\}$) until at some point it is switched to bidirected edges for edges in $A$. The path may end with final directed edge $\leftarrow$ to a node in $A$. To do this consider the following rule table. 

<Ruletable id="optimal_iv_admg"/>

Here, we use the fact that $A = V \setminus D$, hence only $D$ needs to be passed. $S$ is the set of starting nodes and $F$ gives us the possibility to restrict nodes to be visited further. As can be seen, the table tracks exactly the kind of paths described above. It returns only the reached nodes in $A$ using the colors ```pass``` and ```yield```. Hence, $W^{\text{opt}}$ can be computed as follows.

```r
W <- reach(g, list("S" = y, "D" = des, "F" = x), optIVTable)
```

Now, consider $Z^{\text{opt}}$ and observe that descendants of $x$ can never be connected to it via $x \leftarrow \cdots$ due to the acyclicity of the underlying graph. Hence, we can use the same table to compute this set (here in combination with ```setdiff```). 

```r
Z <- setdiff(reach(g, list("S" = x, "D" = des, "F" = c()), optIVTable), W)
```

#### Checking the optimality condition
The resulting sets $Z$ and $W$ are valid, provided $Z$ is non-empty, which is trivial to check outside of CIfly. The other condition is that $Z$ contains a parent or sibling of $x$. While this could also be checked using CIfly, clearly it is preferred to do this directly in R. TODO

#### Full implementation
TODO

<ExampleCode id="optimalIV.R"/>

